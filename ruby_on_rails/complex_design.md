# 複雑な処理を実装するために
## 概要
- これは、パーフェクトRuby On RailsのPart5(第11~13章)のまとめです。
## 11章. 複雑なドメインを表現する
### ドメインモデルとアクティブレコード
- アプリケーションが対象とする問題領域のことをドメインという。
- ドメインを分析して構成概念を抽出することをモデリングと呼び、その結果得られた概念のことをドメインモデルと呼ぶ。これだけではアプリケーションを形にすることはできないので、ドメインモデルの状態をデータとして保存し、アプリケーションを形にする。
  - アクティブレコードと呼ばれるアーキテクチャパターンを用いて、データベースのレコードとオブジェクトを対応づけている。
    - アクティブレコードは、データの取得・保存処理とドメインロジックを合わせてカプセル化するアーキテクチャパターンである。(その構造上、単体では複雑なドメインロジックを表現しきれない。)
    - データベースのテーブルをクラス、レコードをクラスのインスタンス、カラムをインスタンスの属性に対応させる。
- アクティブレコードだけではうまく表現できないドメインロジックには以下の2つが主にある。
  - **ドメインに固有の「値」に関するロジック**
  - **複数のオブジェクトを組み合わせて表現するロジック**
### ドメインに固有の「値」に関するロジック
- 複数のモデルから扱われる特定の意味を持った値を実装したい時に用いる。
  - composed_ofを用いると、元となるクラスの処理を簡潔に実装できる。
- メリットは以下である。
  - 実装したロジックを複数のモデル間で簡単に再利用できる。
  - モデルの肥大化も防げる。
### 複数のオブジェクトを組み合わせて表現するロジック
- 以下の順序で実装を検討する。
  - 1. 実装するロジックが、モデルに実装して不自然なロジックではないか？と考える 
  - 2. 不自然なら、対応するイベント（主に記録処理）を見落としていないか？考える。
  - 3. イベントが存在する場合は、以下の観点で比較を行い、モデルを新規で実装するか、サービスクラスを用いるか？を検討する。
    - 関連するオブジェクトが少なければモデルを新規作成する、関連するオブジェクトが多ければサービスクラスが良い。
      - テストの記述の観点から。
      - もちろん、データとしてイベントを記録し、再利用する場合には、モデルを素直に増やした方がよい。
- サービスクラスを実装する際には、以下の点を考慮すること。
  - 「ユーザ認証サービス」や「合計金額計算サービス」、「口座間の送金サービス」といったドメインロジックそのものを指す名前がつける。
    - ある一つのドメインロジックを指すものにする。
  - ロジックを実行するためのクラスメソッドを1つだけ実装する。
  - クラスの外からはインスタンスを生成できないようにする。（サービスにオブジェクトの状態(attributes)を持たせない。）